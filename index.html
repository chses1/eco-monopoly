<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <title>ç’°ä¿å°å°–å…µå¤§å¯Œç¿</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-image: url('https://www.chses.tyc.edu.tw/UpFile/Cairo1680/backgroung.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: #000;
      font-size: 1.2rem;
    }
    .container {
      width: 100%;
      margin: 0 auto;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 0 20px;
      gap: 10px;
      box-sizing: border-box;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-auto-rows: 150px;
      grid-gap: 4px;
      position: relative;
      width: 1200px;
      margin: 0 auto;
    }
    .cell {
      height: 150px;
      min-height: unset;
      border: 1px solid #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      text-align: center;
      background-color: #f0f0f0;
      position: relative;
      padding: 12px 16px;
      box-sizing: border-box;
      word-break: break-word;
    }
    .cell-text {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
      text-align: center;
      line-height: 1.4;
      font-size: clamp(0.9rem, 1.1vw, 1.2rem);
      overflow: visible;
    }
    .cell img {
      width: 48px;
      height: 48px;
      margin-bottom: 4px;
    }
    .highlight {
      background-color: #ffeb3b;
      animation: pulse 0.8s ease-in-out 2;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }
    .victory-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      animation: fadeIn 1s ease-in-out;
    }
    .victory-banner {
      background: #fff;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      text-align: center;
      animation: popIn 0.6s ease;
    }
    .victory-banner h2 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      color: #d32f2f;
    }
    .victory-banner button {
      font-size: 1.5rem;
      padding: 10px 30px;
      margin-top: 10px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    @keyframes popIn {
      0% { transform: scale(0.5); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes shakeDice {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(20deg); }
      50% { transform: rotate(-20deg); }
      75% { transform: rotate(10deg); }
      100% { transform: rotate(0deg); }
    }
    .dice-shake {
      color: #d32f2f;
      font-weight: bold;
      display: inline-block;
      animation: shakeDice 0.5s ease-in-out;
    }
    @keyframes floatUp {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-50px); opacity: 0; }
    }
    #score-float {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 4rem;
      color: #ff4081;
      font-weight: bold;
      animation: floatUp 1s ease-out forwards;
      pointer-events: none;
      z-index: 9999;
    }
    @keyframes popTrophy {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); }
    }
    #win-screen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9998;
    }
    #win-screen .trophy {
      font-size: 6rem;
      animation: popTrophy 1s ease;
      color: gold;
      text-align: center;
    }
    .popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .popup-content {
      background: white;
      padding: 2rem 3rem;
      font-size: 2rem;
      border-radius: 16px;
      animation: popIn 0.5s ease;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <h1 style="font-size: 4rem; color: #ffeb3b; text-shadow: 3px 3px 6px #000; font-weight: bold; margin-bottom: 20px;">ğŸŒ ç’°ä¿å°å°–å…µå¤§å¯Œç¿ ğŸŒ¿</h1>
  <!-- æ¨¡å¼åˆ‡æ›é–‹é—œ -->
  <div id="mode-switch" style="margin-bottom:20px; font-size:1.8rem;">
    <label>
      <input type="checkbox" id="toggle-mode"> åˆ‡æ›åˆ°æ‰‹å‹•æ¨¡å¼
    </label>
  </div>
  <div class="container">
    <div style="flex: 0 0 400px; display: flex; flex-direction: column; align-items: center; gap: 20px; font-size: 2rem; margin-top: 20px; background-color: rgba(255,255,255,0.85); padding: 20px; border-radius: 10px;">
      <div id="teacher-tip" style="font-size: 2.4rem; font-weight: bold; color: darkorange; text-align: center;">ğŸ‘‰ è¼ªåˆ° <img src="https://www.chses.tyc.edu.tw/UpFile/Cairo1680/player1.png" style="width: 48px; vertical-align: middle; margin-right: 6px;"><span style="color: deepskyblue; font-weight: bold;">è—éµ²</span> æ“²éª°å­</div>
      <button id="roll-btn" onclick="rollDice()" style="display: flex; align-items: center; justify-content: center; width: 100%; aspect-ratio: 3/1; font-size: 2.4rem; padding: 0; border-radius: 20px; background: #ffeb3b; border: 3px solid #333; white-space: nowrap;">ğŸ² æ“²éª°å­</button>
      <div id="dice-animation" style="font-size: 5rem; text-align: center; height: 80px; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #d32f2f;">ğŸ² 1</div>
      <p id="status" style="font-size: 2.4rem; font-weight: bold; min-height: 2.2rem; white-space: nowrap; color: red;"></p>
      <div id="question-box" style="display:none; max-width: 90vw; padding: 10px; background-color: rgba(255,255,255,0.9); border-radius: 10px; font-size: 1.4rem;">
        <p id="question"></p>
        <div class="decision-buttons">
          <button onclick="judgeAnswer(true)" style="font-size: 1.5rem;">â­• ç­”å°</button>
          <button onclick="judgeAnswer(false)" style="font-size: 1.5rem;">âŒ ç­”éŒ¯</button>
        </div>
      </div>
      <div id="action-icon" style="font-size: 2rem; color: red; font-weight: bold;"></div>
    </div>
    <div class="board" id="board"></div>
    <div style="flex: 0 0 400px; display: flex; flex-direction: column; align-items: center; gap: 20px; font-size: 2rem; margin-top: 20px; background-color: rgba(255,255,255,0.85); padding: 20px; border-radius: 10px;">
      <div style="font-size: 2.4rem; font-weight: bold; margin-bottom: 10px;">ğŸ¯ åˆ†æ•¸çµ±è¨ˆ</div>
      <div style="background: #e0f7fa; padding: 10px 20px; border-radius: 8px; width: calc(100% - 10px); text-align: left; box-sizing: border-box;">
        <img alt="è—éµ²" src="https://www.chses.tyc.edu.tw/UpFile/Cairo1680/player1.png" style="width:48px; vertical-align: middle; margin-right: 6px;"/>è—éµ²ï¼š <span id="score-blue">0</span> åˆ†
      </div>
      <div style="background: #e8eaf6; padding: 10px 20px; border-radius: 8px; width: calc(100% - 10px); text-align: left; box-sizing: border-box;">
        <img alt="ç¶ ç¹¡çœ¼" src="https://www.chses.tyc.edu.tw/UpFile/Cairo1680/player2.png" style="width:48px; vertical-align: middle; margin-right: 6px;"/>ç¶ ç¹¡çœ¼ï¼š <span id="score-green">0</span> åˆ†
      </div>
      <div style="margin-top: 20px; font-size: 1.2rem; line-height: 1.6;">
        ğŸ“œ <strong>éŠæˆ²è¦å‰‡ï¼š</strong><br/>é›™æ–¹è¼ªæµæ“²éª°å‰é€²ï¼Œç¬¬ä¸€ä½ç²å¾— 3 åˆ†çš„éšŠä¼å³ç²å‹ï¼
      </div>
      <button id="roll-btn-duplicate" onclick="rollDice()" style="display: block; width: 100%; margin-top: 12px; padding: 10px; font-size: 1.8rem; border-radius: 12px; background: #ffeb3b; border: 3px solid #333; box-sizing: border-box;">ğŸ² æ“²éª°å­</button>
      <div id="dice-animation-2" style="font-size: 5rem; text-align: center; height: 80px; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #d32f2f;">ğŸ² 1</div>
    </div>
  </div>
  <audio id="audio-correct" preload="auto" src="correct.mp3"></audio>
  <audio id="audio-wrong" preload="auto" src="wrong.mp3"></audio>
  <!-- å¾—åˆ†å‹•ç•«å€ -->
  <div class="popup" id="score-popup" style="display: none;">
    <div class="popup-content" id="score-message">ğŸ ç²å¾— 1 åˆ†ï¼Œ5 ç§’å¾Œç¹¼çºŒéŠæˆ²</div>
  </div>
  <div id="score-float" style="display:none;">+1 åˆ†ï¼</div>
  <div id="win-screen" style="display:none;">
    <div style="text-align: center;">
      <div class="trophy" style="font-size: 6rem; margin-bottom: 1rem;">ğŸ†</div>
      <div style="font-size: 2.5rem; color: white;">éé—œæˆåŠŸï¼</div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    // éŠæˆ²è¦å‰‡èˆ‡è®Šæ•¸å®£å‘Š
    const layout = [
      "èµ·é»",
      "ä½ åƒåŠ éè·³èš¤å¸‚å ´å—",
      "èªªå‡ºä¸€ç¨®å°ç£ç‰¹æœ‰ç¨®å‹•ç‰©",
      "äº‚ç æ¨¹æœ¨æœƒç™¼ç”Ÿä»€éº¼äº‹",
      "å›åˆ°èµ·é»",
      "èªªå‡ºä¸€å€‹æš–åŒ–å°åœ°çƒçš„å‚·å®³", 
      "èªªå‡ºç©ºæ°£æ±™æŸ“å°äººé«”çš„å‚·å®³",    
      "ä½ æ‹¿ä»€éº¼è£½ä½œç’°ä¿æ¸…æ½”åŠ‘",    
      "å‰é€²å…©æ­¥",
      "æ€éº¼ä¿è­·å‹•ç‰©",    
      "èªªå‡ºå¡‘è† å°æµ·æ´‹ç”Ÿç‰©çš„å‚·å®³",    
      "ç”¨éçš„ç´™ç›’é‚„å¯ä»¥åšä»€éº¼",    
      "å‰é€²ä¸‰æ­¥",  
      "æ´—ç±³æ°´é‚„å¯ä»¥æ‹¿ä¾†åšä»€éº¼",  
      "èˆ‰å‡ºä¸€ç¨®æ¸›å¡‘çš„æ–¹æ³•", 
      "èªªå‡ºä¸€ç¨®ä½æ±¡æŸ“çš„äº¤é€šå·¥å…·",
      "å¾Œé€€å…©æ­¥",   
      "ç¯€é›»è¡Œå‹•ï¼šé—œé–‰ä¸€ç›é›»é¢¨æ‰‡",   
      "å¹å†·æ°£æœƒé€ æˆåœ°çƒæš–åŒ–å—",   
      "èµ°è·¯ä¸Šå­¸å¯ä»¥æ¸›å°‘ç©ºæ±™å—",   
      "æˆ‘å€‘æ€éº¼æ„›è­·å±±æ—",  
      "å°ç£æ¸›å¡‘æœ‰ä»€éº¼è¦å®š",   
      "å¾Œé€€å…©æ­¥",
      "å†°å±±èåŒ–æœƒå‚·å®³ä»€éº¼å‹•ç‰©",
      "æ€éº¼æ„›æƒœé£Ÿç‰©",
      "èªªå‡ºä¸€ç¨®ç€•è‡¨çµ•ç¨®çš„å‹•ç‰©",
      "ç¯€æ°´è¡Œå‹•ï¼šæª¢æŸ¥èµ°å»Šæ°´é¾é ­", 
      "æ±¡æ°´è™•ç†å» åœ¨åšä»€éº¼",  
      "æˆ‘æ„›åœ°çƒèªªä¸‰æ¬¡",
      "çµ‚é»"
    ];
    const specialMove = {
      "å‰é€²å…©æ­¥": 2,
      "å‰é€²ä¸‰æ­¥": 3,
      "å¾Œé€€å…©æ­¥": -2,
      "å›åˆ°èµ·é»": "start"
    };
    const boardSize = layout.length;
    let positions = [0, 0];
    let scores = [0, 0];
    let currentPlayer = 0;
    let skipTurn = [false, false];

    // æ¨¡å¼ç›¸é—œå…¨åŸŸè®Šæ•¸ï¼ˆé è¨­ç‚ºè‡ªå‹•æ¨¡å¼ï¼‰
    let isManualMode = false;
    let manualMoveInProgress = false;
    let manualOldPos = 0;
    let manualDiceRoll = 0; // ç”¨ä¾†è¨˜éŒ„æ‰‹å‹•æ¨¡å¼ä¸‹æ“²å‡ºçš„éª°å­é»æ•¸

    const boardEl = document.getElementById('board');
    const playerImages = [
      'https://www.chses.tyc.edu.tw/UpFile/Cairo1680/player2.png', // ç¶ ç¹¡çœ¼
      'https://www.chses.tyc.edu.tw/UpFile/Cairo1680/player1.png'  // è—éµ²
    ];

    // å»ºç«‹æ£‹ç›¤
    for (let row = 0; row < 5; row++) {
      for (let col = 0; col < 6; col++) {
        let index = row * 6 + (row % 2 === 0 ? col : 5 - col);
        if (index >= boardSize) continue;
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.id = `cell-${index}`;
        let arrow = 'â¡ï¸';
        if (col === 5 && row % 2 === 0 && row < 4) arrow = 'â¬‡ï¸';
        else if (col === 0 && row % 2 === 1 && row < 4) arrow = 'â¬‡ï¸';
        else if (row % 2 === 1) arrow = 'â¬…ï¸';
        cell.innerHTML = `<div class='cell-text'>${layout[index]}</div><div class='arrow'>${arrow}</div>`;
        boardEl.appendChild(cell);
      }
    }

    // ç‚ºæ¯å€‹æ ¼å­æ–°å¢é»æ“Šäº‹ä»¶ï¼ˆåƒ…åœ¨æ‰‹å‹•æ¨¡å¼ä¸”å°šæœªç§»å‹•ä¸­æ™‚è§¸ç™¼ï¼‰
    document.querySelectorAll('.cell').forEach(cell => {
      cell.addEventListener('click', function() {
        if (!isManualMode || manualMoveInProgress) return;
        let parts = this.id.split("-");
        if (parts.length < 2) return;
        let targetIndex = parseInt(parts[1]);
        if (isNaN(targetIndex)) return;
        // ä¿å­˜åŸæœ¬ä½ç½®ä»¥ä¾›ç­”éŒ¯æ™‚é‚„åŸ
        manualOldPos = positions[currentPlayer];
        document.getElementById('question-box').dataset.prev = manualOldPos;
        manualMoveInProgress = true;
        positions[currentPlayer] = targetIndex;
        updateBoard();
        document.getElementById('question').textContent = layout[targetIndex];
        document.getElementById('question-box').style.display = 'block';
      });
    });

    // æ›´æ–°æ•™å¸«æç¤ºï¼ˆé¡¯ç¤ºç•¶å‰ç©å®¶ï¼Œè‹¥æ‰‹å‹•æ¨¡å¼é™„åŠ æç¤ºï¼‰
    function updateTeacherTip() {
      const tipEl = document.getElementById('teacher-tip');
      const icon = currentPlayer === 0
        ? '<img src="https://www.chses.tyc.edu.tw/UpFile/Cairo1680/player2.png" style="width:48px; vertical-align:middle; margin-right:6px;">'
        : '<img src="https://www.chses.tyc.edu.tw/UpFile/Cairo1680/player1.png" style="width:48px; vertical-align:middle; margin-right:6px;">';
      const name = currentPlayer === 0
        ? '<span style="color: limegreen; font-weight: bold;">ç¶ ç¹¡çœ¼</span>'
        : '<span style="color: deepskyblue; font-weight: bold;">è—éµ²</span>';
      let tipMsg = `ğŸ‘‰ è¼ªåˆ° ${icon}${name} æ“²éª°å­`;
      if (isManualMode) {
        tipMsg += " ã€æ‰‹å‹•æ¨¡å¼ï¼šè«‹é»é¸æ£‹ç›¤ç§»å‹•ã€‘";
      }
      tipEl.innerHTML = tipMsg;
    }

    // æ›´æ–°æ£‹ç›¤ç•«é¢ï¼ˆé‡ç¹ªæ£‹ç›¤åŠç©å®¶åœ–ç¤ºï¼‰
    function updateBoard() {
      layout.forEach((_, i) => {
        const cell = document.getElementById(`cell-${i}`);
        if (cell) {
          const row = Math.floor(i / 6);
          const col = row % 2 === 0 ? i % 6 : 5 - (i % 6);
          let arrow = 'â¡ï¸';
          if (col === 5 && row % 2 === 0 && row < 4) arrow = 'â¬‡ï¸';
          else if (col === 0 && row % 2 === 1 && row < 4) arrow = 'â¬‡ï¸';
          else if (row % 2 === 1) arrow = 'â¬…ï¸';
          cell.innerHTML = `<div class='cell-text'>${layout[i]}</div><div class='arrow'>${arrow}</div>`;
          cell.querySelectorAll('img').forEach(img => img.remove());
        }
      });
      positions.forEach((pos, idx) => {
        const target = document.getElementById(`cell-${pos}`);
        if (target) {
          let container = target.querySelector('.player-container');
          if (!container) {
            container = document.createElement('div');
            container.className = 'player-container';
            container.style.display = 'flex';
            container.style.gap = '4px';
            container.style.justifyContent = 'center';
            container.style.alignItems = 'center';
            target.prepend(container);
          }
          const img = document.createElement('img');
          img.src = playerImages[idx];
          img.alt = `player${idx + 1}`;
          if (pos > 0) {
            const direction = pos % 12 < 6 ? 'right' : 'left';
            img.style.transform = direction === 'left' ? 'scaleX(-1)' : 'scaleX(1)';
          }
          container.appendChild(img);
        }
      });
      document.getElementById('score-green').textContent = scores[0];
      document.getElementById('score-blue').textContent = scores[1];
    }

    // æ“²éª°å­å‡½æ•¸ï¼šè‡ªå‹•æ¨¡å¼ä¸‹ä¾éª°å­é»æ•¸ç§»å‹•ï¼›æ‰‹å‹•æ¨¡å¼ä¸‹åƒ…é¡¯ç¤ºé»æ•¸ä¸”é–å®šéª°å­æŒ‰éˆ•
    function rollDice() {
      const rollBtn = document.getElementById("roll-btn");
      const rollBtn2 = document.getElementById("roll-btn-duplicate");
      if (!rollBtn) return;
      rollBtn.disabled = true;
      rollBtn2.disabled = true;
      document.getElementById('action-icon').innerHTML = '';

      if (skipTurn[currentPlayer]) {
        skipTurn[currentPlayer] = false;
        document.getElementById('action-icon').innerHTML = 'â¸ï¸ æš«åœä¸€å›åˆï¼';
        currentPlayer = 1 - currentPlayer;
        updateTeacherTip();
        rollBtn.disabled = false;
        rollBtn2.disabled = false;
        return;
      }

      const roll = Math.floor(Math.random() * 6) + 1;
      const diceContainer = document.getElementById("dice-animation");
      const diceContainer2 = document.getElementById("dice-animation-2");
      diceContainer.innerHTML = `<span class="dice-shake">ğŸ² ${roll}</span>`;
      diceContainer2.innerHTML = `<span class="dice-shake">ğŸ² ${roll}</span>`;
      setTimeout(() => {
        diceContainer.innerHTML = `ğŸ² ${roll}`;
        diceContainer2.innerHTML = `ğŸ² ${roll}`;
      }, 500);
      const status = document.getElementById('status');
      status.innerHTML = `<img src="${playerImages[currentPlayer]}" style="width:48px; vertical-align:middle; margin-right:6px;">${currentPlayer === 0 ? 'ç¶ ç¹¡çœ¼' : 'è—éµ²'} æ“²å‡º ${roll} é»`;
      status.style.color = currentPlayer === 0 ? 'limegreen' : 'deepskyblue';
      
      if (isManualMode) {
        // æ‰‹å‹•æ¨¡å¼ä¸‹ï¼Œä¿ç•™éª°å­é»æ•¸ä½†æŒçºŒé–å®šéª°å­æŒ‰éˆ•ï¼Œç­‰å¾…ç©å®¶é»é¸æ£‹ç›¤ä¸¦ç­”é¡Œ
        manualDiceRoll = roll;
        return;
      }
      
      // è‡ªå‹•æ¨¡å¼ï¼šä¾éª°å­é»æ•¸è‡ªå‹•ç§»å‹•
      let newPos = positions[currentPlayer] + roll;
      if (newPos >= boardSize - 1) {
        const playerName = currentPlayer === 0 ? 'ç¶ ç¹¡çœ¼' : 'è—éµ²';
        scores[currentPlayer]++;
        if (scores[currentPlayer] >= 3) {
          const overlay = document.createElement('div');
          overlay.className = 'victory-overlay';
          overlay.innerHTML = `
            <div class='victory-banner'>
              <h2>ğŸ‰ ${playerName} ç²å‹ï¼</h2>
              <button onclick='restartGame()'>é‡æ–°é–‹å§‹</button>
            </div>`;
          document.body.appendChild(overlay);
          showWinScreen();
          positions = [0, 0];
          scores = [0, 0];
          updateBoard();
          updateTeacherTip();
          return;
        } else {
          showScorePopup(playerName);
          showScoreAnimation();
          const remainingSteps = newPos - (boardSize - 1);
          positions[currentPlayer] = 0;
          updateBoard();
          setTimeout(() => moveSteps(remainingSteps), 800);
        }
        if (scores[currentPlayer] >= 3) {
          const overlay = document.createElement('div');
          overlay.className = 'victory-overlay';
          overlay.innerHTML = `
            <div class='victory-banner'>
              <h2>ğŸ‰ ${currentPlayer === 0 ? 'ç¶ ç¹¡çœ¼' : 'è—éµ²'} ç²å‹ï¼</h2>
              <button onclick='restartGame()'>é‡æ–°é–‹å§‹</button>
            </div>`;
          document.body.appendChild(overlay);
          showWinScreen();
          positions = [0, 0];
          scores = [0, 0];
        } else {
          positions[currentPlayer] = 0;
        }
        updateBoard();
        updateTeacherTip();
        rollBtn.disabled = false;
        rollBtn2.disabled = false;
        return;
      }
      positions[currentPlayer] = newPos;
      updateBoard();
      updateTeacherTip();
      const currentEvent = layout[newPos];
      const currentCell = document.getElementById(`cell-${newPos}`);
      if (specialMove.hasOwnProperty(currentEvent) || currentEvent === 'æš«åœä¸€æ¬¡') {
        currentCell.classList.add('highlight');
        playSound();
        setTimeout(() => currentCell.classList.remove('highlight'), 1200);
      }
      if (specialMove.hasOwnProperty(currentEvent)) {
        const steps = specialMove[currentEvent];
        if (steps === "start") {
          playSound(false);
          positions[currentPlayer] = 0;
        } else {
          if (steps > 0) playSound(true);
          else playSound(false);
          positions[currentPlayer] += steps;
          if (positions[currentPlayer] < 0) positions[currentPlayer] = 0;
        }
        updateBoard();
        updateTeacherTip();
        currentPlayer = 1 - currentPlayer;
        updateTeacherTip();
        rollBtn.disabled = false;
        rollBtn2.disabled = false;
        return;
      }
      if (currentEvent === "æš«åœä¸€æ¬¡") {
        playSound(false);
        skipTurn[currentPlayer] = true;
        document.getElementById('action-icon').innerHTML = 'â¸ï¸ æš«åœä¸€å›åˆï¼';
        updateBoard();
        updateTeacherTip();
        currentPlayer = 1 - currentPlayer;
        updateTeacherTip();
        rollBtn.disabled = false;
        rollBtn2.disabled = false;
        return;
      }
      // ä¸€èˆ¬æƒ…æ³ï¼šå‡ºç¾å•é¡Œè®“ç©å®¶å›ç­”
      document.getElementById('question').textContent = currentEvent;
      document.getElementById('question-box').style.display = 'block';
      document.getElementById('question-box').dataset.prev = newPos - roll;
    }

    // moveSteps() ç”¨æ–¼è‡ªå‹•æ¨¡å¼çš„è£œä½å‹•ä½œ
    function moveSteps(steps) {
      if (steps <= 0) {
        currentPlayer = 1 - currentPlayer;
        updateTeacherTip();
        document.getElementById("roll-btn").disabled = false;
        document.getElementById("roll-btn-duplicate").disabled = false;
        return;
      }
      positions[currentPlayer]++;
      if (positions[currentPlayer] >= boardSize) positions[currentPlayer] = boardSize - 1;
      updateBoard();
      updateTeacherTip();
      const currentEvent = layout[positions[currentPlayer]];
      const currentCell = document.getElementById(`cell-${positions[currentPlayer]}`);
      if (specialMove.hasOwnProperty(currentEvent)) {
        const stepsMove = specialMove[currentEvent];
        if (stepsMove === "start") {
          positions[currentPlayer] = 0;
        } else {
          positions[currentPlayer] += stepsMove;
          if (positions[currentPlayer] < 0) positions[currentPlayer] = 0;
        }
        updateBoard();
        updateTeacherTip();
      } else if (currentEvent === "æš«åœä¸€æ¬¡") {
        skipTurn[currentPlayer] = true;
        document.getElementById('action-icon').innerHTML = 'â¸ï¸ æš«åœä¸€å›åˆï¼';
      }
      setTimeout(() => moveSteps(steps - 1), 600);
    }

    // ç©å®¶å›ç­”çµæœè™•ç†ï¼ˆæ­£ç¢ºä¿ç•™è©²æ ¼ï¼ŒéŒ¯èª¤é‚„åŸåŸä½ç½®ï¼‰
    function judgeAnswer(correct) {
      playSound(correct);
      const rollBtn = document.getElementById("roll-btn");
      const rollBtn2 = document.getElementById("roll-btn-duplicate");
      // è‹¥ç‚ºæ‰‹å‹•æ¨¡å¼ä¸”åˆ°é”çµ‚é»ä¸”ç­”å°ï¼Œå‰‡è¨ˆåˆ†èˆ‡å‹åˆ©åˆ¤å®š
      if (isManualMode && positions[currentPlayer] >= boardSize - 1 && correct) {
        const playerName = currentPlayer === 0 ? 'ç¶ ç¹¡çœ¼' : 'è—éµ²';
        scores[currentPlayer]++;
        if (scores[currentPlayer] >= 3) {
          const overlay = document.createElement('div');
          overlay.className = 'victory-overlay';
          overlay.innerHTML = `
            <div class='victory-banner'>
              <h2>ğŸ‰ ${playerName} ç²å‹ï¼</h2>
              <button onclick='restartGame()'>é‡æ–°é–‹å§‹</button>
            </div>`;
          document.body.appendChild(overlay);
          showWinScreen();
          positions = [0, 0];
          scores = [0, 0];
          updateBoard();
          updateTeacherTip();
          return;
        } else {
          showScorePopup(playerName);
          showScoreAnimation();
          positions[currentPlayer] = 0;
          updateBoard();
          updateTeacherTip();
          document.getElementById("question-box").style.display = "none";
          manualMoveInProgress = false;
          currentPlayer = 1 - currentPlayer;
          updateTeacherTip();
          // è§£é–éª°å­æŒ‰éˆ•ä¾›ä¸‹ä¸€ä½ç©å®¶æ“²éª°
          rollBtn.disabled = false;
          rollBtn2.disabled = false;
          return;
        }
      }
      if (!correct) {
        const prev = parseInt(document.getElementById('question-box').dataset.prev);
        positions[currentPlayer] = isNaN(prev) ? positions[currentPlayer] : prev;
        updateBoard();
      }
      document.getElementById("question-box").style.display = "none";
      manualMoveInProgress = false;
      currentPlayer = 1 - currentPlayer;
      updateTeacherTip();
      // è§£é–éª°å­æŒ‰éˆ•ï¼Œä¾›ä¸‹ä¸€ä½ç©å®¶æ“²éª°
      rollBtn.disabled = false;
      rollBtn2.disabled = false;
    }

    function restartGame() {
      positions = [0, 0];
      scores = [0, 0];
      skipTurn = [false, false];
      currentPlayer = 0;
      document.getElementById('status').textContent = '';
      document.getElementById('action-icon').textContent = '';
      document.getElementById('question-box').style.display = 'none';
      const overlay = document.querySelector('.victory-overlay');
      if (overlay) overlay.remove();
      updateBoard();
      updateTeacherTip();
      document.getElementById('roll-btn').disabled = false;
      document.getElementById('roll-btn-duplicate').disabled = false;
      playSound(true);
    }

    function playSound(correct = true) {
      const correctAudio = document.getElementById("audio-correct");
      const wrongAudio = document.getElementById("audio-wrong");
      [correctAudio, wrongAudio].forEach(audio => {
        audio.pause();
        audio.currentTime = 0;
      });
      (correct ? correctAudio : wrongAudio).play();
    }

    function showScorePopup(playerName) {
      const popup = document.getElementById("score-popup");
      const message = document.getElementById("score-message");
      message.innerText = `ğŸ ${playerName} ç²å¾— 1 åˆ†ï¼Œ5 ç§’å¾Œç¹¼çºŒéŠæˆ²`;
      popup.style.display = "flex";
      setTimeout(() => {
        popup.style.display = "none";
      }, 5000);
    }

    function showScoreAnimation() {
      const scoreSound = document.getElementById('audio-score');
      if (scoreSound) { scoreSound.currentTime = 0; scoreSound.play(); }
      const float = document.getElementById('score-float');
      float.style.display = 'block';
      float.style.animation = 'none';
      float.offsetHeight;
      float.style.animation = 'floatUp 1s ease-out forwards';
      setTimeout(() => {
        float.style.display = 'none';
      }, 1000);
      confetti({
        particleCount: 80,
        spread: 100,
        origin: { y: 0.6 }
      });
    }

    function showWinScreen() {
      const victorySound = document.getElementById('audio-victory');
      if (victorySound) { victorySound.currentTime = 0; victorySound.play(); }
      document.getElementById('win-screen').style.display = 'flex';
      setTimeout(() => {
        document.getElementById('win-screen').style.display = 'none';
      }, 3000);
    }

    // æ¨¡å¼åˆ‡æ›ï¼šåˆ‡æ›æ™‚åƒ…æ›´æ–°æ¨¡å¼è®Šæ•¸èˆ‡æ•™å¸«æç¤ºï¼ˆéª°å­æŒ‰éˆ•å§‹çµ‚é¡¯ç¤ºï¼‰
    document.getElementById("toggle-mode").addEventListener("change", function() {
      isManualMode = this.checked;
      updateTeacherTip();
    });

    // åˆå§‹åŒ–æç¤ºèˆ‡æ£‹ç›¤
    updateTeacherTip();
    updateBoard();
  </script>
  <audio id="audio-score" preload="auto" src="score.mp3"></audio>
  <audio id="audio-victory" preload="auto" src="victory.mp3"></audio>
</body>
</html>
